import{r as a,x as te,a3 as W,a0 as me,W as P,j as e,C as se,h as q,a as ne,b5 as Y,i as xe,k as D,G as C,b6 as fe,b7 as je,g as B,ah as ge,aV as re,aW as ae,aX as ie,o as oe,b8 as we,e as X,n as pe,b0 as Ce,M as b,f as le,aJ as be,K as _,b3 as ye,aj as Se,aS as ve,aT as _e,V as Ne,T as Re,O as De,b9 as Ie,ba as ke,bb as Ae,bc as Le,az as Te}from"./react-vendor-CllrtqDN.js";import{j as R,d as T,k as Fe,q as Ee,t as Me,v as Oe,i as ze,A as Ve,b as Z,w as He}from"./index-jGxgGxBB.js";import{u as $e,M as Ge}from"./useDeckFromUrl-3TlTnJir.js";import{F as qe,S as o,R as x,i as Be,t as v}from"./utils-UxpEuF8F.js";import{s as U}from"./setSetting-BtX1gh1a.js";import"./database-_ZSyCo0Q.js";import{S as J}from"./Stat-D5t7p8L1.js";import{D as We}from"./DangerousConfirmModal-DL1P1d32.js";import{d as Pe}from"./deleteNote-DPZEKTwH.js";import"./vendor-kP31MWcD.js";import"./editor-C2bVNK98.js";import"./mantine-charts-Bb-jmQwj.js";import"./rxjs-DNGqVrHU.js";const Ke={byCreationDate:t=>(s,n)=>(s.creationDate.getTime()-n.creationDate.getTime())*t,byCustomOrder:t=>(s,n)=>s.customOrder===void 0||n.customOrder===void 0?0:(s.customOrder-n.customOrder)*Math.abs(t),byCardType:t=>(s,n)=>s.content.type.localeCompare(n.content.type)*t,byDeckName:t=>(s,n)=>s.deckName.localeCompare(n.deckName)*t},N=new qe;function Ue(){const[t]=R("globalScheduler_maximumInterval"),[s]=R("globalScheduler_requestRetention"),[n]=R("globalScheduler_w");return a.useEffect(()=>{N.p.maximum_interval=t,N.p.request_retention=s,N.p.w=n},[t,s,n]),N}function Je(){U("globalScheduler_maximumInterval",N.p.maximum_interval),U("globalScheduler_requestRetention",N.p.request_retention),U("globalScheduler_w",N.p.w)}function Xe(t,s){return te(()=>t(T.cards).then(n=>[n,n!==void 0]),s,[void 0,!1])}async function Qe(t,s,n){return T.cards.update(t.id,{model:s,history:[...t.history,n]})}function Ye(){return{deck:"[not set]",day:new Date().toISOString().split("T")[0],time:{total:0,forNew:0,forReview:0,forLearning:0},cards:{[o.New]:0,[o.Review]:0,[o.Learning]:0,[o.Relearning]:0},ratingsList:[]}}async function Ze(t){const s=await T.statistics.get([t.deck,t.day]);s?T.statistics.put({deck:t.deck,day:t.day,time:{total:s.time.total+t.time.total,forNew:s.time.forNew+t.time.forNew,forReview:s.time.forReview+t.time.forReview,forLearning:s.time.forLearning+t.time.forLearning},cards:{[o.New]:s.cards[o.New]+t.cards[o.New],[o.Review]:s.cards[o.Review]+t.cards[o.Review],[o.Learning]:s.cards[o.Learning]+t.cards[o.Learning],[o.Relearning]:s.cards[o.Relearning]+t.cards[o.Relearning]},ratingsList:s.ratingsList.concat(t.ratingsList)}):T.statistics.add(t)}function et(t,s){const[n]=Xe(t.querier,t.dependencies),l=Ue(),[i,g]=a.useState([]),[r,w]=a.useState([]),[m,h]=a.useState([]),[p,I]=a.useState([]),[u,f]=a.useState(null),[k,y]=a.useState(!1),[F,E]=a.useState(!1),[M,ce]=a.useState(!1),[Q,de]=a.useState(()=>Ye());a.useEffect(()=>{if(n)if(i.length+r.length+m.length+p.length===0&&u===null){const d=new Date(Date.now());g(n.filter(c=>c.model.state===o.Learning||c.model.state===o.Relearning)),w(n.filter(c=>c.model.state===o.New).sort(s.sort)),h(n.filter(c=>c.model.state===o.Review&&c.model.due<=d).sort(s.sort)),I(n.filter(c=>c.model.state===o.Review&&c.model.due>d).sort(s.sort))}else u===null&&K()},[n,u,i,r,m,p,s]);const K=a.useCallback(()=>{M||(i.length>0&&i[0].model.due<=new Date(Date.now())?(f(i[0]),g(d=>d.filter((c,j)=>j!==0))):r.length+m.length>0?r.length===0?(f(m[0]),h(d=>d.filter((c,j)=>j!==0))):m.length===0?(f(r[0]),w(d=>d.filter((c,j)=>j!==0))):Math.random()<s.newToReviewRatio?(f(r[0]),w(d=>d.filter((c,j)=>j!==0))):(f(m[0]),h(d=>d.filter((c,j)=>j!==0))):s.learnAll&&p.length>0?(f(p[0]),I(d=>d.filter((c,j)=>j!==0))):i.length>0?(f(i[0]),g(d=>d.filter((c,j)=>j!==0))):(ce(!0),Je()))},[i,r,m,p,s]);a.useEffect(()=>{F&&(K(),E(!1))},[F,K]);const S=a.useMemo(()=>u?l.repeat(u.model,new Date(Date.now())):null,[u]),ue=a.useCallback(d=>{if(u&&S)u.model.state===o.Review&&u.model.due.getTime()>=Date.now()||Qe(u,S[d].card,S[d].review_log),S[d].card.scheduled_days===0&&g(c=>[...c,{...u,model:S[d].card}].sort((j,he)=>j.model.due.getTime()-he.model.due.getTime())),de(c=>({...c,ratingsList:[...c.ratingsList,d],cards:{...c.cards,[u.model.state]:c.cards[u.model.state]+1}}));else throw new Error("Card or cardModelInfo is missing");y(!1)},[u,S,i,Q]);return{newCardsNumber:r.length,timeCriticalCardsNumber:i.length,toReviewCardsNumber:m.length,learnedCardsNumber:p.length,currentCard:u,currentCardRepeatInfo:S,showingAnswer:k,showAnswer:y.bind(null,!0),answerCard:ue,requestNextCard:E.bind(null,!0),statistics:Q,isFinished:M,options:s}}function tt(t){return a.useMemo(()=>{if(t.length!==0){let s=0;return t.forEach(n=>s+=(n-1)/2),Math.round(s/t.length*1e3)/10}else return Number.NaN},[t])}function st(t){return te(()=>T.notes.get(t),[t],void 0)}const nt="_trophyIcon_5ewf9_1",rt={trophyIcon:nt};function at({statistics:t,time:s,deckId:n}){const l=W(),[i]=me(),[g]=R("name"),r=tt(t.ratingsList),[w,m]=a.useState(!1);return P([["Space",()=>l("/home")],["Enter",()=>l("/home")],["d",()=>l(`/deck/${n}`)]]),a.useEffect(()=>{w||n&&(t.deck=n,Ze(t),m(!0))},[n]),e.jsx(se,{children:e.jsxs(q,{gap:"xl",align:"center",pt:"xl",children:[e.jsx(ne,{size:"6rem",radius:"60%",className:rt.trophyIcon,children:e.jsx(Y,{stroke:.75,size:50})}),e.jsx(xe,{children:g?i("learning.finished-congrats-name",{name:g}):i("learning.finished-congrats")}),e.jsx(D,{style:{textAlign:"center"},children:i("learning.finished-info")}),e.jsxs(C,{wrap:"nowrap",w:"100%",maw:"600px",justify:"center",children:[e.jsx(J,{name:i("learning.finished-duration"),value:s?s.minutes+"m "+s.seconds+"s":"not available",icon:fe,color:"orange"}),e.jsx(J,{name:i("learning.finished-accuracy-ratio"),value:r?r+"%":"not available",icon:Y,color:"green"}),e.jsx(J,{name:i("learning.finished-repetions-count"),value:t.ratingsList.length,icon:je,color:"blue"})]}),e.jsxs(q,{gap:"sm",children:[e.jsx(B,{onClick:()=>l("/home"),leftSection:e.jsx(ge,{}),size:"md",children:i("learning.finished-button-home")}),e.jsx(B,{onClick:()=>l(`/deck/${n}`),size:"md",variant:"subtle",children:i("learning.finished-button-to-deck")})]})]})})}const it="_indicator_15o3c_1",ot={indicator:it};function O({color:t,icon:s,text:n}){return e.jsxs(C,{className:ot.indicator,gap:"0.25rem",align:"center",style:{color:`var(--mantine-color-${t}-strong`},children:[e.jsx(s,{size:16}),e.jsx(D,{fz:"sm",fw:500,children:n})]})}function lt({currentCardModel:t}){const s=a.useCallback(()=>{if(t!==void 0)return t.state===o.New?e.jsx(O,{color:"grape",icon:re,text:"New card"}):t.state===o.Learning||t.state===o.Relearning?e.jsx(O,{color:"orange",icon:ae,text:"Learn card"}):t.state===o.Review&&t.due<=new Date(Date.now())?e.jsx(O,{color:"blue",icon:ie,text:"Review card"}):e.jsx(O,{color:"gray",icon:oe,text:"Already learned"})},[t]);return t===void 0?null:s()}const ct="_learnView_b674h_1",dt="_learnViewWrapper_b674h_14",ut="_cardContainer_b674h_18",ht="_card_b674h_18",mt="_footerContainer_b674h_44",xt="_progressBar_b674h_53",L={learnView:ct,learnViewWrapper:dt,cardContainer:ut,card:ht,footerContainer:mt,progressBar:xt};function z({label:t,timeInfo:s,color:n,action:l}){return e.jsx(B,{color:n,onClick:()=>l(),h:"2.5rem",px:0,fullWidth:!0,miw:"0",children:e.jsxs(q,{gap:"0",align:"center",children:[e.jsx(D,{fz:"xs",fw:400,lh:"1",children:s}),e.jsx(D,{fz:"sm",fw:600,lh:"1.25",children:t})]})})}const V=1e3*60*60*24,ft=1e3*60;function H(t,s){var i;if(!s.currentCardRepeatInfo)return"";const n=new Intl.RelativeTimeFormat(Be.language,{style:"short",numeric:"auto"}),l=((i=s.currentCardRepeatInfo[t])==null?void 0:i.card.due.getTime())-Date.now();return l>=V*30?n.format(Math.round(l/(V*30)),"month"):l>=V*.9?n.format(Math.round(l/V),"day"):"~ "+n.format(Math.round(l/ft),"minute")}function jt({controller:t,answer:s}){return P(t.isFinished?[]:[["1",()=>s(x.Again)],["2",()=>s(x.Hard)],["3",()=>s(x.Good)],["4",()=>s(x.Easy)],["Space",()=>t.showingAnswer?s(x.Good):t.showAnswer()],["Enter",()=>t.showingAnswer?s(x.Good):t.showAnswer()]]),e.jsx(C,{className:L.footerContainer,justify:"center",children:t.showingAnswer?e.jsxs(C,{gap:"xs",wrap:"nowrap",justify:"center",w:"100%",maw:"25rem",children:[e.jsx(z,{label:"Again",timeInfo:H(x.Again,t),color:"red",action:()=>s(x.Again)}),e.jsx(z,{label:"Hard",timeInfo:H(x.Hard,t),color:"yellow",action:()=>s(x.Hard)}),e.jsx(z,{label:"Good",timeInfo:H(x.Good,t),color:"green",action:()=>s(x.Good)}),e.jsx(z,{label:"Easy",timeInfo:H(x.Easy,t),color:"blue",action:()=>s(x.Easy)})]}):e.jsx(B,{onClick:t.showAnswer,h:"2.5rem",children:"Show Answer"})})}function gt({card:t}){const s=a.useMemo(()=>t?t.history.map(n=>({date:n.review.getTime(),rating:n.rating})):[],[t]);return e.jsx(we,{h:300,data:s,series:[{name:"rating",color:"forest"}],dataKey:"date",curveType:"monotone",withTooltip:!0,gridAxis:"x",yAxisProps:{domain:[1,4],tickCount:4,tickFormatter:n=>{switch(n){case 1:return"Again";case 2:return"Hard";case 3:return"Good";case 4:return"Easy"}return""}},xAxisProps:{domain:["dataMin",new Date(Date.now()).getTime()],scale:"linear",tickFormatter:n=>new Date(n).toLocaleDateString()},connectNulls:!0})}function wt({opened:t,setOpened:s,card:n}){return e.jsx(X,{opened:t,onClose:()=>s(!1),title:"Statistics",children:e.jsx(gt,{card:n})})}const pt="_table_16kxf_1",$={table:pt};function Ct({card:t}){return t?e.jsxs(q,{className:$.container,children:[e.jsx("table",{className:$.table,children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("th",{children:"Card Type:"}),e.jsx("td",{children:t.content.type})]}),e.jsxs("tr",{children:[e.jsx("th",{children:"ID:"}),e.jsx("td",{children:t.id})]}),e.jsxs("tr",{children:[e.jsx("th",{children:"Custom Order:"}),e.jsx("td",{children:t.customOrder})]}),e.jsxs("tr",{children:[e.jsx("th",{children:"Content:"}),e.jsx("td",{children:JSON.stringify(t.content)})]}),e.jsxs("tr",{children:[e.jsx("th",{children:"Decks:"}),e.jsxs("td",{children:[e.jsx(pe,{href:"/deck/"+t.deck,children:t.deck}),","," "]})]})]})}),e.jsxs("table",{className:$.table,children:[e.jsx("thead",{children:e.jsx("th",{children:"FSRS Model"})}),e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("th",{children:"Due:"}),e.jsxs("td",{children:[t.model.due.toLocaleDateString(),",",t.model.due.toLocaleTimeString()]})]}),e.jsxs("tr",{children:[e.jsx("th",{children:"Stability:"}),e.jsx("td",{children:t.model.stability})]}),e.jsxs("tr",{children:[e.jsx("th",{children:"Difficulty:"}),e.jsx("td",{children:t.model.difficulty})]}),e.jsxs("tr",{children:[e.jsx("th",{children:"Elapsed Days:"}),e.jsx("td",{children:t.model.elapsed_days})]}),e.jsxs("tr",{children:[e.jsx("th",{children:"Scheduled Days:"}),e.jsx("td",{children:t.model.scheduled_days})]}),e.jsxs("tr",{children:[e.jsx("th",{children:"Repetitions:"}),e.jsx("td",{children:t.model.reps})]}),e.jsxs("tr",{children:[e.jsx("th",{children:"Lapses:"}),e.jsx("td",{children:t.model.lapses})]}),e.jsxs("tr",{children:[e.jsx("th",{children:"State:"}),e.jsx("td",{children:t.model.state})]}),e.jsxs("tr",{children:[e.jsx("th",{children:"Last Review:"}),e.jsxs("td",{children:[t.model.last_review.toLocaleDateString(),",",t.model.last_review.toLocaleTimeString()]})]})]})]}),e.jsxs("table",{className:$.table,children:[e.jsx("thead",{children:e.jsx("th",{children:"History"})}),e.jsxs("tbody",{children:[t.history.length,t.history.map(s=>e.jsxs(a.Fragment,{children:[e.jsxs("tr",{children:[e.jsx("th",{children:"Date: "}),e.jsxs("td",{children:[s.review.toLocaleDateString(),",",s.review.toLocaleTimeString()]})]}),e.jsxs("tr",{children:[e.jsx("th",{children:"Result: "}),e.jsxs("td",{children:[x[s.rating]," (",s.rating,")"]})]}),e.jsxs("tr",{children:[e.jsx("th",{children:"State: "}),e.jsxs("td",{children:[o[s.state]," (",s.state,")"]})]}),e.jsxs("tr",{children:[e.jsx("th",{children:"Elapsed Days: "}),e.jsx("td",{children:s.elapsed_days})]}),e.jsxs("tr",{children:[e.jsx("th",{children:"Scheduled Days: "}),e.jsx("td",{children:s.scheduled_days})]}),e.jsx("tr",{children:e.jsx(Ce,{h:"xs"})})]},s.review.toISOString()))]})]})]}):e.jsx(D,{color:"dimmed",fz:"sm",children:"This card could not be found."})}function bt({opened:t,setOpened:s,card:n}){try{return e.jsx(X,{opened:t,onClose:()=>s(!1),title:"Debug",children:e.jsx(Ct,{card:n})})}catch(l){return console.error(l),e.jsx(D,{c:"red",fw:"700",fz:"sm",children:"Faulty cart"})}}function yt({card:t,onDelete:s}){const n=W(),[l]=R("developerMode"),[i,g]=a.useState(!1),[r,w]=a.useState(!1),m=Fe();P([["s",()=>w(!0)],["o",()=>{}],["shift+d",()=>g(!0)],["e",()=>n(`/notes/${h==null?void 0:h.deck}/${h==null?void 0:h.id}`)],["Backspace",()=>f(!0)]]);const[h,p]=a.useState(),I=a.useCallback(async()=>{t&&p(await Ee(t.note))},[t]);a.useEffect(()=>{I()},[t]);const[u,f]=a.useState(!1);async function k(){if(h)try{await Pe(h),s&&s(),f(!1),Me("note")}catch(y){Oe("note"),console.log(y)}}return t?e.jsxs(e.Fragment,{children:[e.jsxs(b,{position:"bottom-end",children:[e.jsx(b.Target,{children:e.jsx(le,{variant:"subtle",color:"gray",children:e.jsx(be,{})})}),e.jsxs(b.Dropdown,{children:[h&&e.jsx(b.Item,{leftSection:e.jsx(ye,{size:16}),rightSection:m&&e.jsx(_,{children:"e"}),onClick:()=>n(`/notes/${h.deck}/${h.id}`),children:v("note.menu.edit")}),e.jsx(b.Item,{leftSection:e.jsx(Se,{size:16}),rightSection:m&&e.jsx(_,{children:"s"}),onClick:()=>w(!0),children:v("card.menu.statistics")}),e.jsx(b.Item,{leftSection:e.jsx(ve,{size:16}),rightSection:m&&e.jsx(_,{children:"o"}),disabled:!0,children:v("card.menu.options")}),l&&e.jsx(b.Item,{leftSection:e.jsx(_e,{size:16}),rightSection:m&&e.jsxs(C,{align:"center",gap:"0.25rem",children:[e.jsx(_,{children:"shift"}),"+",e.jsx(_,{children:"d"})]}),onClick:()=>g(!0),children:v("card.menu.debug")}),e.jsx(b.Item,{color:"red",leftSection:e.jsx(Ne,{size:16}),rightSection:m&&e.jsx(_,{children:"â†"}),onClick:()=>f(!0),children:v("note.menu.delete")})]})]}),e.jsx(wt,{opened:r,setOpened:w,card:t}),e.jsx(bt,{opened:i,setOpened:g,card:t}),e.jsx(We,{dangerousAction:()=>k(),dangerousDependencies:[h],dangerousTitle:v("note.delete-modal.title"),dangerousDescription:v("note.delete-modal.description"),opened:u,setOpened:f})]}):null}const St="_container_4am8l_1",vt={container:St};function _t({controller:t}){return e.jsxs(C,{align:"end",gap:"xs",className:vt.container,wrap:"nowrap",children:[e.jsx(G,{value:t.newCardsNumber,color:"grape",icon:e.jsx(re,{})}),e.jsx(G,{value:t.timeCriticalCardsNumber,color:"orange",icon:e.jsx(ae,{})}),e.jsx(G,{value:t.toReviewCardsNumber,color:"blue",icon:e.jsx(ie,{})}),e.jsx(G,{value:t.learnedCardsNumber,color:"gray",icon:e.jsx(oe,{})})]})}function G({value:t,color:s,icon:n}){return e.jsxs(C,{gap:"0.125rem",wrap:"nowrap",style:{color:`var(--mantine-color-${s}-strong`},children:[e.jsx(ne,{style:{color:`var(--mantine-color-${s}-strong`},variant:"transparent",size:20,children:n}),e.jsx(D,{fz:"sm",fw:600,style:{color:`var(--mantine-color-${s}-strong)`},children:t})]})}let A;function Nt(){const t=ke.useStopwatch({autoStart:!0});return a.useEffect(()=>{A=t},[t]),e.jsx(e.Fragment,{})}function Rt({currentCard:t,controller:s,deck:n}){const l=W();P([["d",()=>l("/deck/"+(n==null?void 0:n.id))]]);const i=a.useMemo(()=>s.statistics.ratingsList.length/(s.statistics.ratingsList.length+s.newCardsNumber*2+s.toReviewCardsNumber+s.timeCriticalCardsNumber+(s.options.learnAll?s.learnedCardsNumber:0))*100,[s.isFinished,s.statistics.ratingsList,s.newCardsNumber,s.toReviewCardsNumber,s.timeCriticalCardsNumber,s.learnedCardsNumber]);return e.jsxs(e.Fragment,{children:[e.jsxs(C,{justify:"space-between",wrap:"nowrap",children:[e.jsxs(C,{wrap:"nowrap",gap:"xs",children:[e.jsx(Re,{label:e.jsxs(e.Fragment,{children:["Back to deck ",e.jsx(_,{children:"d"})]}),children:e.jsx(le,{onClick:()=>l("/deck/"+(n==null?void 0:n.id)),variant:"subtle",color:"gray",children:e.jsx(De,{})})}),e.jsx(Nt,{})]}),e.jsxs(C,{justify:"flex-end",wrap:"nowrap",gap:"xs",children:[e.jsx(_t,{controller:s}),e.jsx(yt,{card:t,onDelete:s.requestNextCard})]})]}),e.jsx(Ie,{className:L.progressBar,size:"xs",value:i,transitionDuration:200,radius:0,w:"100%"})]})}const Dt="_visualFeedback_uh07d_1",It="_Easy_uh07d_14",kt="_Good_uh07d_15",At="_Hard_uh07d_16",Lt="_Again_uh07d_17",ee={visualFeedback:Dt,Easy:It,Good:kt,Hard:At,Again:Lt};function Tt({rating:t}){return e.jsx("div",{className:ee.visualFeedback+" "+(t===null?"":ee[x[t]])})}function Kt(){var u,f,k,y,F;const[t]=R("useVisualFeedback"),s=W(),[n,l,i]=$e(),[g]=R("learn_newToReviewRatio"),r=et({querier:()=>He(n),dependencies:[n]},{learnAll:i==="all",newToReviewRatio:g,sort:Ke.byCreationDate(1)}),w=(k=st((f=(u=r.currentCard)==null?void 0:u.note)!=null?f:""))==null?void 0:k.content,[m,h]=a.useState(null),[p]=Ae(r.isFinished,50),I=a.useCallback(async E=>{try{r.answerCard(E),r.requestNextCard(),h(E),setTimeout(()=>h(null),150)}catch(M){ze(),console.log(M)}},[r]);return a.useEffect(()=>{r.isFinished?A&&A.pause():A&&A.start()},[r.isFinished]),l&&!n?e.jsx(Ge,{}):e.jsxs("div",{className:L.learnView,children:[e.jsx(Ve,{children:e.jsx(Rt,{currentCard:(y=r.currentCard)!=null?y:void 0,controller:r,deck:n})}),e.jsxs(Le,{direction:"column",justify:"space-between",h:"100%",w:"100%",className:L.learnViewWrapper,children:[t&&e.jsx(Tt,{rating:m}),e.jsx(se,{className:L.cardContainer,children:e.jsxs(Te,{className:L.card,children:[e.jsx(lt,{currentCardModel:(F=r.currentCard)==null?void 0:F.model}),!r.showingAnswer&&r.currentCard&&Z(r.currentCard).displayQuestion(r.currentCard,w),r.showingAnswer&&r.currentCard&&Z(r.currentCard).displayAnswer(r.currentCard,w)]})}),e.jsx(jt,{controller:r,answer:I}),e.jsx(X,{opened:p,onClose:()=>s("/home"),fullScreen:!0,closeOnClickOutside:!1,closeOnEscape:!1,withCloseButton:!1,transitionProps:{transition:"fade"},children:e.jsx(at,{statistics:r.statistics,time:A,deckId:n==null?void 0:n.id})})]})]})}export{Kt as default};
